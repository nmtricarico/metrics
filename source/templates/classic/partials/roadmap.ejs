<% if (plugins.roadmap) { %>
  <section class="roadmap">
    <h2 class="field">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M5.22 1.22a.75.75 0 011.06 0l1.22 1.22h2.5a1.5 1.5 0 011.342.833l1.233 2.465h1.175a.75.75 0 010 1.5h-1.75a.75.75 0 01-.671-.413l-1.425-2.85H8.5a.75.75 0 01-.53-.22L6.72 2.78 4.28 5.22 5.5 6.44a.75.75 0 010 1.06l-3 3a.75.75 0 01-1.06-1.06l2.47-2.47L2.47 5.72a.75.75 0 010-1.06l2.75-2.75zM9 8.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5H9.75A.75.75 0 019 8.75zm-2 3.5A.75.75 0 017.75 11.5h3.5a.75.75 0 010 1.5h-3.5A.75.75 0 017 12.25zm5 0a.75.75 0 01.75-.75h1a.75.75 0 010 1.5h-1a.75.75 0 01-.75-.75z"></path></svg>
      <%= plugins.roadmap.title %>
    </h2>
    <% if (plugins.roadmap.error) { %>
      <div class="row">
        <section>
          <div class="field error">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.343 13.657A8 8 0 1113.657 2.343 8 8 0 012.343 13.657zM6.03 4.97a.75.75 0 10-1.06 1.06L6.94 8 4.97 9.97a.75.75 0 101.06 1.06L8 9.06l1.97 1.97a.75.75 0 101.06-1.06L9.06 8l1.97-1.97a.75.75 0 10-1.06-1.06L8 6.94 6.03 4.97z"></path></svg>
            <%= plugins.roadmap.error.message %>
          </div>
        </section>
      </div>
    <% } else { %>
      <%
        const data = plugins.roadmap
        const left = data.branches?.left ?? {title: "", stops: []}
        const right = data.branches?.right ?? {title: "", stops: []}
        const margin = 60
        const spacing = 100
        const baseY = 120
        const branchOffset = 60
        const leftY = baseY - branchOffset
        const rightY = baseY + branchOffset
        const branchMax = Math.max(left.stops.length, right.stops.length, 1)
        const forkX = margin + (data.main.length - 1) * spacing
        const convergeX = forkX + spacing * (branchMax + 1)
        const mainNodes = data.main.map((label, index) => ({label, x: margin + index * spacing, y: baseY}))
        const leftNodes = left.stops.map((label, index) => ({label, x: forkX + spacing * (index + 1), y: leftY}))
        const rightNodes = right.stops.map((label, index) => ({label, x: forkX + spacing * (index + 1), y: rightY}))
        const finalNodes = data.final.map((label, index) => ({label, x: convergeX + spacing * (index + 1), y: baseY}))
        const width = (finalNodes.length ? finalNodes[finalNodes.length - 1].x : convergeX) + margin
        const height = 220
        const convergePoint = {x: convergeX, y: baseY}
        const mainPath = mainNodes.map(({x, y}, index) => `${index ? "L" : "M"} ${x} ${y}`).join(" ")
        const leftPath = leftNodes.length
          ? `M ${forkX} ${baseY} C ${forkX + spacing / 2} ${baseY - branchOffset / 2}, ${leftNodes[0].x - spacing / 2} ${leftY}, ${leftNodes[0].x} ${leftY}`
            + leftNodes.slice(1).map(({x, y}) => ` L ${x} ${y}`).join("")
            + ` C ${leftNodes[leftNodes.length - 1].x + spacing / 2} ${leftY}, ${convergePoint.x - spacing / 2} ${baseY - branchOffset / 2}, ${convergePoint.x} ${convergePoint.y}`
          : ""
        const rightPath = rightNodes.length
          ? `M ${forkX} ${baseY} C ${forkX + spacing / 2} ${baseY + branchOffset / 2}, ${rightNodes[0].x - spacing / 2} ${rightY}, ${rightNodes[0].x} ${rightY}`
            + rightNodes.slice(1).map(({x, y}) => ` L ${x} ${y}`).join("")
            + ` C ${rightNodes[rightNodes.length - 1].x + spacing / 2} ${rightY}, ${convergePoint.x - spacing / 2} ${baseY + branchOffset / 2}, ${convergePoint.x} ${convergePoint.y}`
          : ""
        const finalPath = finalNodes.length
          ? `M ${convergePoint.x} ${convergePoint.y}` + finalNodes.map(({x, y}) => ` L ${x} ${y}`).join("")
          : ""
      %>
      <div class="roadmap__wrapper" style="--roadmap-color-main: <%= data.palette.main %>; --roadmap-color-left: <%= data.palette.left %>; --roadmap-color-right: <%= data.palette.right %>; --roadmap-color-final: <%= data.palette.final %>;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 <%= width %> <%= height %>" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
          <% if (mainPath) { %>
            <path class="roadmap__path roadmap__path--main" d="<%= mainPath %>" />
          <% } %>
          <% if (leftPath) { %>
            <path class="roadmap__path roadmap__path--left" d="<%= leftPath %>" />
          <% } %>
          <% if (rightPath) { %>
            <path class="roadmap__path roadmap__path--right" d="<%= rightPath %>" />
          <% } %>
          <% if (finalPath) { %>
            <path class="roadmap__path roadmap__path--final" d="<%= finalPath %>" />
          <% } %>

          <% for (const node of mainNodes) { %>
            <circle class="roadmap__node roadmap__node--main" cx="<%= node.x %>" cy="<%= node.y %>" r="12" />
            <text class="roadmap__label roadmap__label--main" x="<%= node.x %>" y="<%= node.y + 28 %>"><%= node.label %></text>
          <% } %>

          <% if (leftNodes.length && left.title) { %>
            <text class="roadmap__label roadmap__label--branch" x="<%= leftNodes[0].x %>" y="<%= leftY - 22 %>"><%= left.title %></text>
          <% } %>
          <% for (const node of leftNodes) { %>
            <circle class="roadmap__node roadmap__node--left" cx="<%= node.x %>" cy="<%= node.y %>" r="10" />
            <text class="roadmap__label roadmap__label--branch-stop" x="<%= node.x %>" y="<%= node.y - 18 %>"><%= node.label %></text>
          <% } %>

          <% if (rightNodes.length && right.title) { %>
            <text class="roadmap__label roadmap__label--branch" x="<%= rightNodes[0].x %>" y="<%= rightY + 32 %>"><%= right.title %></text>
          <% } %>
          <% for (const node of rightNodes) { %>
            <circle class="roadmap__node roadmap__node--right" cx="<%= node.x %>" cy="<%= node.y %>" r="10" />
            <text class="roadmap__label roadmap__label--branch-stop" x="<%= node.x %>" y="<%= node.y + 26 %>"><%= node.label %></text>
          <% } %>

          <circle class="roadmap__node roadmap__node--merge" cx="<%= convergePoint.x %>" cy="<%= convergePoint.y %>" r="9" />
          <% if (data.merge) { %>
            <text class="roadmap__label roadmap__label--merge" x="<%= convergePoint.x %>" y="<%= convergePoint.y - 24 %>"><%= data.merge %></text>
          <% } %>

          <% for (const node of finalNodes) { %>
            <circle class="roadmap__node roadmap__node--final" cx="<%= node.x %>" cy="<%= node.y %>" r="12" />
            <text class="roadmap__label roadmap__label--final" x="<%= node.x %>" y="<%= node.y + 28 %>"><%= node.label %></text>
          <% } %>
        </svg>
      </div>
    <% } %>
  </section>
<% } %>
